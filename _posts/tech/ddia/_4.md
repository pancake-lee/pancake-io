---
title: "DDIA笔记-第四章-编码与演化"
description: ""
author: Pancake
date: 2018-05-10
categories: Tech
tags: DDIA
---

## 第四章

### 需求

本章的原始需求是“升级”。

- 对于服务端，我们可能需要滚动升级/阶段发布，则更新部分服务节点，观察是否运行正常，在逐步发布完所有节点。
- 对于客户端，强制更新可能会导致用户流失，非强制更新或者热更新都可能导致多个版本的同时存在。

总的来说，我们需要考虑双向兼容：

- 向后兼容 (backward compatibility)
  - 新的代码可以读取由旧的代码写入的数据。
  - 这不难，可能只是繁琐，会花更多的时间
  - 因为旧的代码只要不删，就能处理旧的数据
  - 如何处理旧数据只是“新代码作者”如何整理、整合“旧代码”而已
  - 可能是用一个迁移脚本，先把所有旧数据变成新数据的格式
  - 可能是新代码同时可以处理两种数据
- 向前兼容 (forward compatibility)
  - 旧的代码可以读取由新的代码写入的数据。
  - 这是比较难的，因为旧版的程序需要忽略新版数据格式中新增的部分。

### 知识点

数据库的区别

- 写时模式
  - 关系数据库，虽然可以更改模式，则 ALTER 语句。
  - 但是对于程序来说，数据库的模式是固定的，则某个表的列是固定的。
- 读时模式
  - 相对的，读时模式数据库不会强制一个模式，
  - 比如 mango 插入同一个集合中的文档的数据格式可以不同，可以通过程序动态读写。

通讯方式

- REST
- RPC
- MQ

编码格式

- JSON
- XML
- Protobuf
- Thrift
- Avro

### 编码格式如何处理兼容性

本章详细讲解了几种编码格式的详细原理。

其中 JSON、XML 的兼容性基本靠应用程序代码本身去处理。

#### 字段标签

而 Protobuf 和 Thrift 等，通过接口定义语言（IDL）描述了模式。
他们提供了每个字段的标签号码以及数据类型，这要求你**不能更改字段的标记**。
只要旧字段的描述没有改变，则保证了**向前兼容性**，因为他们会忽略旧模式外的字段。
这一点上，现在很多 JSON、XML 的处理库也支持，忽略掉多出来的字段，可能需要设置额外配置参数。

另外**向后兼容性**很容易理解，因为旧字段的模式没有改变，所以新代码读取旧数据是没问题的。
需要注意的是，新增加字段时，必须设置为**可选的或具有默认值**，因为旧数据没有他们。

提到了增加字段，那么删除字段也要考虑。
为了保证**向前兼容性**，**只能删除可选字段**，而且**不能再次使用相同的标签号码**。
比如删除了可选字段号码为 3，如果后续新增一个字段也为 3，那么新代码处理旧数据时就获得了错误的数据。

#### 数据类型

这里讨论了数据的转换风险，比如 int64 和 int32 之间，如果新旧模式变更了类型，则导致数据精度问题。
有一个特别的设计是来自于 Protobuf，它没有列表或数组，而是 repeated。
这个字段将以同一个字段标记地出现多次

假设该字段旧模式没有 repeated，而新模式有。
**向前兼容性** 那么没有 repeated 的旧代码，读取新数据，只会读取到最后一个元素的值，可以简单理解为每次读取都覆盖了。
**向后兼容性** 而拥有 repeated 的新代码，读取旧数据，则得到只有一个元素的列表。
